import requests
from flask import Flask,request,render_template,jsonify
import pefile
import os
import array
import math
import pickle
from sklearn.externals import joblib
import sys
import argparse
from malware import *

app = Flask(__name__)


@app.route("/")
def index():
    return render_template("index.html")

@app.route("/analyse",methods = ['POST'])
def analyse():
    path = request.form.get("path")
    clf = joblib.load('classifier/classifier.pkl')
    features = pickle.loads(open(os.path.join('classifier/features.pkl'),'rb').read())
    data = extract_infos(path)
    pe_features = list(map(lambda x:data[x], features))

    res= clf.predict([pe_features])[0]
    res =  ['malware', 'fichier sain'][res]
    #print('Le fichier %s est un %s' % (path,['malware', 'fichier sain'][res]))
    print("===================================" + res)
    return jsonify({"success":True,"verdict":res})
